import de.itemis.mps.gradle.GitBasedVersioning

ext.releaseRepository = 'https://projects.itemis.de/nexus/content/repositories/mbeddr'
ext.snapshotRepository = 'https://projects.itemis.de/nexus/content/repositories/mbeddr_snapshots'

//MPS versions
ext.mpsMajor = "2019.1"
ext.mpsBuild = "2019.1-EAP6"

ext.artifactsDir = new File(rootDir, 'artifacts')

ext.ciBuild = project.findProperty("forceCI") ?: !project.findProperty('mpsHomeDir') && project.findProperty("teamcity")

buildscript {
    if(JavaVersion.current() != JavaVersion.VERSION_1_8){
        throw new GradleException("This build script requires java " + JavaVersion.VERSION_1_8 + ", but you are currently using " + JavaVersion.current())
    }
    repositories {
        mavenLocal()
        maven { url 'https://projects.itemis.de/nexus/content/repositories/mbeddr' }
    }

    dependencies {
        classpath 'de.itemis.mps:mps-gradle-plugin:1' +
                '.0.22.+'
    }
}

subprojects {
    // required plugins
    apply plugin: "base"
    apply plugin: "maven-publish"
    ext.mbeddrMajor = "1"
    ext.mbeddrMinor = "3"

    if (project.hasProperty("mbeddrVersion")) {
        ext.mbeddrBuildNumber = project.getProperty('mbeddrVersion')
    } else {
        // locally versions are SNAPSHOT
        if (ciBuild) {
            // setting mbeddrMajor
            if (project.hasProperty('mbeddrMajor')) {
                ext.mbeddrMajor = project.getProperty('mbeddrMajor')
            }

            // setting mbeddrMinor
            if (project.hasProperty('mbeddrMinor')) {
                ext.mbeddrMinor = project.getProperty('mbeddrMinor')
            }

            // setting mbeddrBuild
            if (project.hasProperty('mbeddrBuild')) {
                ext.mbeddrBuild = project.getProperty('mbeddrBuild')
            } else {
                ext.mbeddrBuild = GitBasedVersioning.getGitBranch()
            }

            if (project.hasProperty("mbeddrBuildCounter")) {
                ext.mbeddrBuildCounter = project.getProperty("mbeddrBuildCounter")
            } else {
                ext.mbeddrBuildCounter = GitBasedVersioning.getGitCommitCount()
            }
            if(mbeddrBuild == "stable" || mbeddrBuild.startsWith("mps-")) {
                mbeddrBuild = "master"
            }
            ext.mbeddrBuildNumber = GitBasedVersioning.getVersion(mbeddrBuild, mbeddrMajor, mbeddrMinor, mbeddrBuildCounter)
            println "##teamcity[buildNumber '${mbeddrBuildNumber}']"
        } else {
            ext.mbeddrBuildNumber = "${ext.mbeddrMajor}.${ext.mbeddrMinor}-SNAPSHOT"
            println "Local build detected. Build will have version $ext.mbeddrBuildNumber"
        }
    }
}

task wrapper(type: Wrapper) {
    gradleVersion '4.4.1'
    distributionType 'all'
}
